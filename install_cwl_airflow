#!/bin/bash

cd /cwl-airflow
sed -ie 's#apache-airflow==2.0.1#apache-airflow==2.0.2#g' setup.py
pip3 install .
pip3 install --upgrade apache-airflow-providers-google
unzip /dependencies/artifacts.zip -d /nsaphutils
pip3 install cwlref-runner /nsaphutils/dist/nsaph_utils-0.0.4.1-py3-none-any.whl
cd ~
wget https://repo.anaconda.com/archive/Anaconda3-2021.05-Linux-x86_64.sh -O anaconda.sh
chmod a+x ./anaconda.sh
./anaconda.sh -b -p ${HOME}/anaconda
pip3 uninstall -y typing
cd /dependencies/
export PATH=${HOME}/anaconda/condabin:$PATH
if [ ! -z "${CONDA_ENV}" ] ;
then
  echo 'installing env from file'
  conda env create -f ${CONDA_ENV}.yml --prefix=${HOME}/${CONDA_ENV}
  #conda init bash
  #echo "conda activate ${CONDA_ENV}" >> ${HOME}/.bashrc
  #source ${HOME}/.bashrc
  exit
else
  echo 'installing default env'
  conda create -y --name NSAPHclimate python=3.6
  #conda init bash
  #echo 'conda activate NSAPHclimate' >> /home/airflow/.bashrc
  #source /home/airflow/.bashrc
  conda install -y -c r r -n NSAPHclimate
  exit
fi
echo 'build ended'